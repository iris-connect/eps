<!DOCTYPE html>
<html lang="en">
<head>
<meta name="generator" content=
"HTML Tidy for HTML5 for Linux version 5.6.0">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content=
"width=device-width, initial-scale=1">
<title>EPS documentation | Service Directory - Overview</title>
<link rel="stylesheet" type="text/css" href=
"/eps/docs/static/css/main.css">
<script>
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']]
    },
    svg: {
      fontCache: 'global'
    }
  };
</script>
<script src="/eps/docs/static/js/mathjax/tex-chtml.js" id=
"MathJax-script" async></script>
<style type="text/css">
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.codehilite .hll { background-color: #ffffcc }
.codehilite { background: #f8f8f8; }
.codehilite .c { color: #8f5902; font-style: italic } /* Comment */
.codehilite .err { color: #a40000; border: 1px solid #ef2929 } /* Error */
.codehilite .g { color: #000000 } /* Generic */
.codehilite .k { color: #204a87; font-weight: bold } /* Keyword */
.codehilite .l { color: #000000 } /* Literal */
.codehilite .n { color: #000000 } /* Name */
.codehilite .o { color: #ce5c00; font-weight: bold } /* Operator */
.codehilite .x { color: #000000 } /* Other */
.codehilite .p { color: #000000; font-weight: bold } /* Punctuation */
.codehilite .ch { color: #8f5902; font-style: italic } /* Comment.Hashbang */
.codehilite .cm { color: #8f5902; font-style: italic } /* Comment.Multiline */
.codehilite .cp { color: #8f5902; font-style: italic } /* Comment.Preproc */
.codehilite .cpf { color: #8f5902; font-style: italic } /* Comment.PreprocFile */
.codehilite .c1 { color: #8f5902; font-style: italic } /* Comment.Single */
.codehilite .cs { color: #8f5902; font-style: italic } /* Comment.Special */
.codehilite .gd { color: #a40000 } /* Generic.Deleted */
.codehilite .ge { color: #000000; font-style: italic } /* Generic.Emph */
.codehilite .gr { color: #ef2929 } /* Generic.Error */
.codehilite .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.codehilite .gi { color: #00A000 } /* Generic.Inserted */
.codehilite .go { color: #000000; font-style: italic } /* Generic.Output */
.codehilite .gp { color: #8f5902 } /* Generic.Prompt */
.codehilite .gs { color: #000000; font-weight: bold } /* Generic.Strong */
.codehilite .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.codehilite .gt { color: #a40000; font-weight: bold } /* Generic.Traceback */
.codehilite .kc { color: #204a87; font-weight: bold } /* Keyword.Constant */
.codehilite .kd { color: #204a87; font-weight: bold } /* Keyword.Declaration */
.codehilite .kn { color: #204a87; font-weight: bold } /* Keyword.Namespace */
.codehilite .kp { color: #204a87; font-weight: bold } /* Keyword.Pseudo */
.codehilite .kr { color: #204a87; font-weight: bold } /* Keyword.Reserved */
.codehilite .kt { color: #204a87; font-weight: bold } /* Keyword.Type */
.codehilite .ld { color: #000000 } /* Literal.Date */
.codehilite .m { color: #0000cf; font-weight: bold } /* Literal.Number */
.codehilite .s { color: #4e9a06 } /* Literal.String */
.codehilite .na { color: #c4a000 } /* Name.Attribute */
.codehilite .nb { color: #204a87 } /* Name.Builtin */
.codehilite .nc { color: #000000 } /* Name.Class */
.codehilite .no { color: #000000 } /* Name.Constant */
.codehilite .nd { color: #5c35cc; font-weight: bold } /* Name.Decorator */
.codehilite .ni { color: #ce5c00 } /* Name.Entity */
.codehilite .ne { color: #cc0000; font-weight: bold } /* Name.Exception */
.codehilite .nf { color: #000000 } /* Name.Function */
.codehilite .nl { color: #f57900 } /* Name.Label */
.codehilite .nn { color: #000000 } /* Name.Namespace */
.codehilite .nx { color: #000000 } /* Name.Other */
.codehilite .py { color: #000000 } /* Name.Property */
.codehilite .nt { color: #204a87; font-weight: bold } /* Name.Tag */
.codehilite .nv { color: #000000 } /* Name.Variable */
.codehilite .ow { color: #204a87; font-weight: bold } /* Operator.Word */
.codehilite .w { color: #f8f8f8 } /* Text.Whitespace */
.codehilite .mb { color: #0000cf; font-weight: bold } /* Literal.Number.Bin */
.codehilite .mf { color: #0000cf; font-weight: bold } /* Literal.Number.Float */
.codehilite .mh { color: #0000cf; font-weight: bold } /* Literal.Number.Hex */
.codehilite .mi { color: #0000cf; font-weight: bold } /* Literal.Number.Integer */
.codehilite .mo { color: #0000cf; font-weight: bold } /* Literal.Number.Oct */
.codehilite .sa { color: #4e9a06 } /* Literal.String.Affix */
.codehilite .sb { color: #4e9a06 } /* Literal.String.Backtick */
.codehilite .sc { color: #4e9a06 } /* Literal.String.Char */
.codehilite .dl { color: #4e9a06 } /* Literal.String.Delimiter */
.codehilite .sd { color: #8f5902; font-style: italic } /* Literal.String.Doc */
.codehilite .s2 { color: #4e9a06 } /* Literal.String.Double */
.codehilite .se { color: #4e9a06 } /* Literal.String.Escape */
.codehilite .sh { color: #4e9a06 } /* Literal.String.Heredoc */
.codehilite .si { color: #4e9a06 } /* Literal.String.Interpol */
.codehilite .sx { color: #4e9a06 } /* Literal.String.Other */
.codehilite .sr { color: #4e9a06 } /* Literal.String.Regex */
.codehilite .s1 { color: #4e9a06 } /* Literal.String.Single */
.codehilite .ss { color: #4e9a06 } /* Literal.String.Symbol */
.codehilite .bp { color: #3465a4 } /* Name.Builtin.Pseudo */
.codehilite .fm { color: #000000 } /* Name.Function.Magic */
.codehilite .vc { color: #000000 } /* Name.Variable.Class */
.codehilite .vg { color: #000000 } /* Name.Variable.Global */
.codehilite .vi { color: #000000 } /* Name.Variable.Instance */
.codehilite .vm { color: #000000 } /* Name.Variable.Magic */
.codehilite .il { color: #0000cf; font-weight: bold } /* Literal.Number.Integer.Long */
</style>
</head>
<body>
<script>
var notice = document.getElementById("translation-notice")
if (localStorage.getItem("translation-notice") === null && notice !== null){
        notice.style.display = "block"
}
</script>
<nav class="navbar is-dark">
<div class="navbar-brand"><span class="navbar-burger burger"
data-target="side-menu" data-toggle="collapse"><span>&nbsp;</span>
<span>&nbsp;</span> <span>&nbsp;</span></span></div>
</nav>
<div class="main">
<div class="side-menu" id="side-menu" data-toggle-class=
"is-active">
<aside class="menu">
<p class="menu-label" style="text-align:center"><a href=
"/eps/docs">EPS documentation</a></p>
<ul class="menu-list">
<li><a href="/eps/docs">Start</a></li>
<li><a href="/eps/docs/getting-started">Getting Started</a></li>
<li><a class="" href="#" data-toggle="collapse" data-target=
"page-eps-nav">EPS Service</a>
<ul class="is-hidden" id="page-eps-nav">
<li><a href="/eps/docs/eps-service">Overview</a></li>
</ul>
</li>
<li><a class="" href="#" data-toggle="collapse" data-target=
"page-proxy-nav">Proxy Service</a>
<ul class="is-hidden" id="page-proxy-nav">
<li><a href="/eps/docs/proxy-service">Overview</a></li>
<li><a href=
"/eps/docs/proxy-service/installation">Installation</a></li>
<li><a href=
"/eps/docs/proxy-service/configuration">Configuration</a></li>
<li><a href="/eps/docs/proxy-service/security">Security & Threat
Model</a></li>
<li><a href="/eps/docs/proxy-service/p2p">Peer-To-Peer (P2P)
Proxy</a></li>
</ul>
</li>
<li><a class="is-active" href="#" data-toggle="collapse"
data-target="page-sd-nav">Service Directory</a>
<ul class="" id="page-sd-nav">
<li><a href="/eps/docs/service-directory">Overview</a></li>
<li><a href=
"/eps/docs/service-directory/installation">Installation</a></li>
<li><a href=
"/eps/docs/service-directory/configuration">Configuration</a></li>
</ul>
</li>
<li><a href="/eps/docs/contact">Contact</a></li>
<li><a href="#" data-toggle="collapse" data-target=
"menu-language-dropdown">Languages</a>
<ul id="menu-language-dropdown" class="is-hidden">
<li><a class="is-open is-active" href=
"/eps/docs/service-directory">English</a></li>
</ul>
</li>
</ul>
</aside>
</div>
<div class="with-comments">
<div class="comments"></div>
<section class="section first">
<div class="content">
<div class="content markdown">
<h1>Service Directory</h1>
<p>The service directory is a central database that contains
information about all operators in the IRIS ecosystem. It contains
information about how operators can be reached and which services
they provide.</p>
<p>The directory allows EPS servers to determine whether and how
they can connect to another operator. Operators that only have
outgoing connectivity (e.g. <code>ga-leipzig</code> in the example
above) can use the directory to learn that they might receive
asynchronous responses from other operators (e.g.
<code>ls-1</code>) and then open outgoing connections to these
operators through which they can receive replies. EPS servers can
also use the service directory to determine whether they should
accept a message from a given operator.</p>
<p>The service directory implements a group-based permissions
mechanism. Currently, only <code>yes/no</code> permissions exist
(i.e. a member of a given group either can or cannot call a given
service method). More fine-grained permissions (e.g. a contact
tracing provider can only edit its own entries in the "locations"
service) need to be implemented by the services themselves. For
that purpose, the EPS server makes information about the calling
peer available to the services via a special parameter
(<code>_caller</code>) that gets passed along with the other RPC
method parameters. This structure also contains the current entry
of the caller from the service directory, making it easy for the
called service to identify and authorize the caller.</p>
<h2>Service Directory API</h2>
<p>The EPS server package also provides a <code>sd</code> API
server command that opens a JSON-RPC server which distributes the
service directory.</p>
<div class="codehilite">
<pre><code><span class="nv">SD_SETTINGS</span><span class=
"o">=</span>settings/dev/roles/sd-1 sd run
</code></pre></div>
<p>By default, this will store and retrieve change records from a
file located at <code>/tmp/service-directory.records</code>. To
reset the service directory, simply delete this file.</p>
<h2>Signature Schema</h2>
<p>All changes in the service directory are cryptographically
signed. For this, every actor in the EPS system has a pair of ECDSA
keys and an accompanying certificate. The service directory is
constructed from a series of <strong>change records</strong>. Each
change record contains the name of an <strong>operator</strong>, a
<strong>section</strong> and the actual data that should be
changed.</p>
<h3>Submitting Change records</h3>
<p>Change records can be submitted to the service directory via the
JSON-RPC API. The <code>eps</code> CLI provides a function for this
via the <code>sd submit-records</code>:</p>
<div class="codehilite">
<pre><code><span class="nv">EPS_SETTINGS</span><span class=
"o">=</span>settings/dev/roles/hd-1 eps sd submit-records settings/dev/directory/001_base.json
</code></pre></div>
<p>You can also reset the service directory by specifying the
<code>--reset</code> flag:</p>
<pre><code>EPS_SETTINGS=settings/dev/roles/hd-1 eps sd submit-records --reset settings/dev/directory/001_base.json
</code></pre>
<p><strong>Warning:</strong> This will erase all previous records
from the service directory. Only operators with an
<code>sd-admin</code> role can do this.</p>
<h3>Retrieving entries and records</h3>
<p>To retrieve change records and entries from the service
directory API you can use the <code>getRecords(since)</code>,
<code>getEntries()</code> and <code>getEntry(name)</code> RPC
calls, e.g. like this:</p>
<div class="codehilite">
<pre><code>curl --key settings/dev/certs/hd-1.key --cert settings/dev/certs/hd-1.crt --cacert settings/dev/certs/root.crt --resolve sd-1:3322:127.0.0.1 https://sd-1:3322/jsonrpc --header <span class="s2">"Content-Type: application/json"</span> --data <span class="s1">'{"jsonrpc": "2.0", "method": "getRecords", "params": {"since": 0}}'</span>
</code></pre></div>
<h3>Signing Data</h3>
<p>The <code>sdh</code> tool includes a <code>sign</code> command
that allows us to sign arbitrary JSON data. It uses the signing
signatures generated by the <code>make certs</code> Make command.
For example, to sign a JSON file, simply use</p>
<pre><code># define the SD settings
export SD_SETTINGS=settings/dev/roles/private-proxy-1/sdh

#sign a service directory entry
sdh sign settings/dev/roles/private-proxy-1/sdh/entry.json
</code></pre>
<p>The output should e.g. look like this:</p>
<div class="codehilite">
<pre><code><span class="p">{</span>
<span class="w">  </span><span class=
"nt">"signature"</span><span class="p">:</span><span class=
"w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">"r"</span><span class=
"p">:</span><span class="w"> </span><span class=
"s2">"67488385997031737348502334621054744305438368369525250023542608571625588981387"</span><span class="p">,</span>
<span class="w">    </span><span class="nt">"s"</span><span class=
"p">:</span><span class="w"> </span><span class=
"s2">"110557266089828975725234959115295121652814407881082688883738138814924173982570"</span><span class="p">,</span>
<span class="w">    </span><span class="nt">"c"</span><span class=
"p">:</span><span class="w"> </span><span class=
"s2">"-----BEGIN CERTIFICATE-----\nMIIC1TCCAb2gAwIBAgIUe3+081Bi4Z0DXDdeBhfZZOAs4OwwDQYJKoZIhvcNAQEL\nBQAwaTELMAkGA1UEBhMCREUxDzANBgNVBAgMBkJlcmxpbjEPMA0GA1UEBwwGQmVy\nbGluMQ0wCwYDVQQKDARJUklTMQswCQYDVQQLDAJJVDEcMBoGA1UEAwwTVGVzdGlu\nZy1EZXZlbG9wbWVudDAeFw0yMTA1MTExMTMzNDBaFw0yMjA5MjMxMTMzNDBaMGUx\nCzAJBgNVBAYTAkRFMQ8wDQYDVQQIDAZCZXJsaW4xDzANBgNVBAcMBkJlcmxpbjEN\nMAsGA1UECgwESVJJUzELMAkGA1UECwwCSVQxGDAWBgNVBAMMD3ByaXZhdGUtcHJv\neHktMTBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IABLHlILI5POvEDJc96W0dbag7\nFt8BVmitGqwS5jarYRwOUe/PiQ8tMBkMw9X/2U8G1qGYQb/CiRDh1DDy/Eh/mGKj\nRDBCMDMGA1UdEQQsMCqCD3ByaXZhdGUtcHJveHktMYIXKi5wcml2YXRlLXByb3h5\nLTEubG9jYWwwCwYDVR0PBAQDAgeAMA0GCSqGSIb3DQEBCwUAA4IBAQAmUESzD1ls\nmpECtRlinhiUduif9nVddtLeW/Ui86PHkS50vjSOVHY7ZHrfWbFB4/p4bwm8Sp1/\npFHx4WyuHiow5Ah3HV9afDcgyWBd1V8ijIFOlNF27u/caVsa9gV7iDVJ+6mBXKkf\nCgNI2bA2WoOVXQMwRoow4vSYrVAdM/Eyq8PHYOHkGqdd4uASG5df4vE+gnB2z9WD\nFuxkVYkncVP5OB+N7EAkQrVjrITdiSN0yYAVWFKz1IEnPF7GRW6KsPHW9lJeePeD\n1gLNh2KF6drrXT2PIIYVB31uepSoCqFnUUDcC/PX0qHu8jilvr/pTzhFUWbuX+Ja\nfaIRxqWB0frZ\n-----END CERTIFICATE-----\n"</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">"data"</span><span class=
"p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class=
"nt">"foo"</span><span class="p">:</span><span class=
"w"> </span><span class="s2">"bar"</span><span class="p">,</span>
<span class="w">    </span><span class=
"nt">"name"</span><span class="p">:</span><span class=
"w"> </span><span class="s2">"private-proxy-1"</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Before importing such data, we can check the signature using the
<code>verify</code> command (you need to specify the expected
<code>name</code> of the signer):</p>
<div class="codehilite">
<pre><code><span class="nb">export</span> <span class=
"nv">SD_SETTINGS</span><span class=
"o">=</span>settings/dev/roles/sd-1/sdh
sdh verify signed.json private-proxy-1
</code></pre></div>
<p>If the signature is valid the exit code will be <code>0</code>,
otherwise <code>1</code>.</p>
</div>
</div>
</section>
</div>
</div>
<script defer type="text/javascript" src=
"/eps/docs/static/js/bulma.js"></script>
</body>
</html>
